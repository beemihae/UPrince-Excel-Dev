<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <!--During development turn off caching-->
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <title></title>

    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>

    <script>
        // The initialize function must be run each time a new page is loaded
        (function () {
            var host = 'https://uprinceuatapi.azurewebsites.net';

            Office.initialize = function (reason) {
                //app.initialize();
                //If you need to initialize something you can do so here.
            };
        })();
        //Notice function needs to be in global namespace
        function writeText(event) {
            dailyLogGET();
            event.completed();
        }

        function dailyLogGET() {
            localStorage.setItem("dailyLog", "false")
            //deleteTable("DailyLog");
            //var projectId = localStorage.getItem('projectId');
            //var userEmail = localStorage.getItem('email');
            app.showNotification('function')
            var urlProject =  "https://uprinceuatapi.azurewebsites.net/api/DailyLog/GetDailyLog";
            var dataEmail =
                {
                    "projectId": "",
                    "project": null,
                    "identifier": "",
                    "title": "",
                    "activity": "",
                    "responsibleStatusString": "",
                    "status": {
                        "All": true,
                        "New": false,
                        "Waiting": false,
                        "Completed": false
                    },
                    "activityType": {
                        "All": true,
                        "Problem": false,
                        "Action": false,
                        "Event": false,
                        "Comment": false,
                        "Decision": false,
                        "Reference": false
                    },
                    "priority": {
                        "All": true,
                        "High": false,
                        "Medium": false,
                        "Low": false
                    },
                    "targetDate": {
                        "All": true,
                        "-7": false,
                        "-1": false,
                        "0": false,
                        "+1": false,
                        "+7": false
                    },
                    "responsibleStatus": {
                        "All": true,
                        "Inbox": false,
                        "Next": false,
                        "Waiting": false,
                        "Schedule": false,
                        "Someday": false,
                        "Done": false
                    },
                    "energy": {
                        "All": true,
                        "Mild": false,
                        "Reasonable": false,
                        "Demanding": false,
                        "Very Demanding": false,
                        "Extreme": false
                    },
                    "responsible": "",
                    "requester": "",
                    "coreUserEmail": "emiel.vanhaesebrouck@uprince.com",
                    "atContext": "",
                    "startDate": "",
                    "orderField": "",
                    "sortOrder": ""
                };
            $.ajax({
                type: "POST",
                url: urlProject,
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(dataEmail),
            })
                .done(function (str) {
                    //app.showNotification(str.dailyLogListViewModel.length);
                    getDailyLog(str.dailyLogListViewModel[1].identifier);
                    var DlId = [str.dailyLogListViewModel.length];
                    if (str.dailyLogListViewModel.length > 0) {
                        var matrix = [str.dailyLogListViewModel.length];
                        for (var i = 0; i < str.dailyLogListViewModel.length; i++) {
                            matrix[i] = [10];
                            DlId[i] = str.dailyLogListViewModel[i].identifier;
                            matrix[i][0] = isNull(str.dailyLogListViewModel[i].project);
                            matrix[i][1] = isNull(str.dailyLogListViewModel[i].activity);
                            matrix[i][2] = isNull(str.dailyLogListViewModel[i].identifier);
                            matrix[i][3] = isNull(str.dailyLogListViewModel[i].atContext);
                            matrix[i][4] = formatDate(str.dailyLogListViewModel[i].targetDate);
                            matrix[i][5] = isNull(str.dailyLogListViewModel[i].responsibleStatus);
                            matrix[i][6] = isNull(str.dailyLogListViewModel[i].responsible);
                            matrix[i][7] = isNull(str.dailyLogListViewModel[i].activityType);
                            matrix[i][8] = isNull(str.dailyLogListViewModel[i].time);
                            matrix[i][9] = isNull(str.dailyLogListViewModel[i].energy);
                            //matrix[i][6] = isNull(str[i].Version);
                            //localStorage.setItem("ParentId" + str[i].Id, str[i].ParentId);
                        }
                    } else {
                        var matrix = [["", "", "", "", "", "", "", "", "", ""]]
                    };

                    localStorage.setItem("DlId", DlId);

                    Excel.run(function (ctx) {
                        var tables = ctx.workbook.tables;
                        var tableRows = tables.getItem('DailyLog').rows
                        for (var i = 0; i < matrix.length; i++) {
                            var line = [1];
                            line[0] = matrix[i];
                            tableRows.add(null, line);
                        };
                        return ctx.sync().then(function () {
                            showMessage("Success! My monthly expense table created! Select the arrow button to see how to remove the table.");
                        })
                         .catch(function (error) {
                             showMessage(JSON.stringify(error));
                         });
                    });


                });
        };

        function getDailyLog(dailyLogId) {
            var urlProject = host + '/api/DailyLog/GetDailyLog?logId=' + dailyLogId + '&email=' + localStorage.getItem("email");
            $.ajax({
                type: 'GET',
                url: urlProject,
                dataType: "json",
                contentType: "application/json; charset=utf-8",

            })
             .done(function (str) {
                 //app.showNotification(str.impact[0].State);
                 Excel.run(function (ctx) {
                     //var matrix = riskValuesImpact(str);
                     if (Object.keys(str.contextList).length != 0) {
                         ctx.workbook.worksheets.getItem('Values').getRange("G1:G" + Object.keys(str.contextList).length).values = dailyLogContext(str)/*[[1], [2], [1], [2], [1]] //str.impact[0].State*/;
                     }
                     if (Object.keys(str.personnelContacts).length != 0) {
                         ctx.workbook.worksheets.getItem('Values').getRange("I1:I" + Object.keys(str.personnelContacts).length).values = dailyLogUsers(str)
                     }
                     ctx.workbook.worksheets.getItem('Values').getRange("H1:H6").values = [["Inbox"], ["Next"], ["Waiting"], ["Schedule"], ["Someday"], ["Done"]]/*[[1], [2], [1], [2], [1]] //str.impact[0].State*/;
                     ctx.workbook.worksheets.getItem('Values').getRange("J1:J6").values = [["Problem"], ["Action"], ["Event"], ["Comment"], ["Decision"], ["Reference"]]/*[[1], [2], [1], [2], [1]] //str.impact[0].State*/;
                     ctx.workbook.worksheets.getItem('Values').getRange("K1:K7").values = [["5 min"], ["15 min"], ["30 min"], ["1 hr"], ["2 hr"], ["4 hr"], ["8 hr"]]/*[[1], [2], [1], [2], [1]] //str.impact[0].State*/;
                     ctx.workbook.worksheets.getItem('Values').getRange("L1:L5").values = [["Mild"], ["Reasonable"], ["Demanding"], ["Very Demanding"], ["Extreme"]]/*[[1], [2], [1], [2], [1]] //str.impact[0].State*/;
                     if (Object.keys(str.project).length != 0) {
                         ctx.workbook.worksheets.getItem('Values').getRange("M1:M" + Object.keys(str.project).length).values = dailyLogProject(str);
                     }

                     return ctx.sync().then(function () {
                         //console.log("Success! Insert range in A1:C3.");
                     });
                 }).catch(function (error) {
                     //app.showNotification(error);
                 });
             })
        };


        function dailyLogContext(str) {
            var val = [Object.keys(str.contextList).length];
            for (var i = 0; i < Object.keys(str.contextList).length; i++) {
                val[i] = [1];
                val[i][0] = str.contextList[i].description;
                localStorage.setItem('dailyLogContext' + str.contextList[i].description, "" + str.contextList[i].id);
                //val[i] = str.impact[i].State;
            }
            //app.showNotification(val[2][0]);
            return val;
        };

        function dailyLogUsers(str) {
            var val = [Object.keys(str.personnelContacts).length];
            for (var i = 0; i < Object.keys(str.personnelContacts).length; i++) {
                val[i] = [1];
                val[i][0] = str.personnelContacts[i].State;
                localStorage.setItem('dailyLogUsers' + str.personnelContacts[i].State, "" + str.personnelContacts[i].StateId);
                //val[i] = str.impact[i].State;
            }
            //app.showNotification(val[2][0]);
            return val;
        }

        function dailyLogProject(str) {
            var val = [Object.keys(str.project).length];
            for (var i = 0; i < Object.keys(str.project).length; i++) {
                val[i] = [1];
                val[i][0] = str.project[i].State;
                localStorage.setItem('dailyLogProject' + str.project[i].State, "" + str.project[i].StateId);
                //val[i] = str.impact[i].State;
            }
            //app.showNotification(val[2][0]);
            return val;
        }

        function publishDailyLog() {
            Excel.run(function (ctx) {
                var rows = ctx.workbook.tables.getItem("DailyLog").rows.load("values");
                return ctx.sync()
                    .then(function () {
                        var DlId = localStorage.getItem('DlId');
                        var projectId = localStorage.getItem('projectId');
                        var urlProject = host + '/api/DailyLog/PostDailyLogHeader';
                        var urlProject2 = host + '/api/DailyLog/PostDailyLogInvolvedTiming';
                        for (var i = 0; i < rows.items.length; i++) {
                            //app.showNotification(rows.items[1].values[0][1]);
                            if (rows.items[i].values[0][2] == null || rows.items[i].values[0][2] == "") {
                                //app.showNotification('No id');
                                var dataEmail = {
                                    "id": rows.items[i].values[0][2],
                                    "projectId": localStorage.getItem("dailyLogProject" + rows.items[i].values[0][0]),
                                    "activityTypeId": isActivityType(rows.items[i].values[0][7]),
                                    "title": isNull(rows.items[i].values[0][1]),
                                    "order": "0",
                                    "coreUserEmail": localStorage.getItem("email"),
                                    "authorEmail": localStorage.getItem("email"),
                                    "context": localStorage.getItem("dailyLogContext" + rows.items[i].values[0][3]),
                                    "energy": isEnergy(rows.items[i].values[0][9])
                                };
                                $.ajax({
                                    type: "POST",
                                    url: urlProject,
                                    dataType: "json",
                                    async: false,
                                    contentType: "application/json; charset=utf-8",
                                    data: JSON.stringify(dataEmail),
                                })
                                .done(function (result) {
                                    addId(i, result);
                                    var dataEmail2 = {
                                        "dailyLogId": result,
                                        "responsible": localStorage.getItem('dailyLogUsers' + rows.items[i].values[0][6]),
                                        "responseStatus": isResponseStatus(rows.items[i].values[0][5]),
                                        "targetDate": formatDate3(rows.items[i].values[0][4]),
                                        "time": isTime(rows.items[i].values[0][8])
                                    };
                                    $.ajax({
                                        type: "POST",
                                        url: urlProject2,
                                        dataType: "json",
                                        contentType: "application/json; charset=utf-8",
                                        data: JSON.stringify(dataEmail2),
                                    });
                                })
                            }
                            else {
                                var dataEmail = {
                                    "id": rows.items[i].values[0][2],
                                    "projectId": localStorage.getItem("dailyLogProject" + rows.items[i].values[0][0]),
                                    "activityTypeId": isActivityType(rows.items[i].values[0][7]),
                                    "title": isNull(rows.items[i].values[0][1]),
                                    "order": "0",
                                    "coreUserEmail": localStorage.getItem("email"),
                                    "authorEmail": localStorage.getItem("email"),
                                    "context": localStorage.getItem("dailyLogContext" + rows.items[i].values[0][3]),
                                    "energy": isEnergy(rows.items[i].values[0][9])
                                };
                                $.ajax({
                                    type: "POST",
                                    url: urlProject,
                                    dataType: "json",
                                    async: false,
                                    contentType: "application/json; charset=utf-8",
                                    data: JSON.stringify(dataEmail),
                                })
                                var dataEmail2 = {
                                    "dailyLogId": rows.items[i].values[0][2],
                                    "responsible": localStorage.getItem('dailyLogUsers' + rows.items[i].values[0][6]),
                                    "responseStatus": isResponseStatus(rows.items[i].values[0][5]),
                                    "targetDate": formatDate3(rows.items[i].values[0][4]),
                                    "time": isTime(rows.items[i].values[0][8])
                                };
                                $.ajax({
                                    type: "POST",
                                    url: urlProject2,
                                    dataType: "json",
                                    contentType: "application/json; charset=utf-8",
                                    data: JSON.stringify(dataEmail2),
                                });
                            };

                        }
                    })
                    .then(ctx.sync)
                    .then(function () {
                        console.log("Success! Format rows of 'Table1' with 2nd cell greater than 2 in green, other rows in red.");
                    });
            }).catch(function (error) {
                console.log(error);
            });
        };

        function addId(range, id) {
            Excel.run(function (ctx) {
                var count = (range + 2);
                //app.showNotification(typeof(range) + "  "+ typeof(range + 1));
                var excelRange = "C" + count + ":C" + count;
                //app.showNotification(excelRange);
                ctx.workbook.worksheets.getItem('DailyLog').getRange(excelRange).values = ("" + id)/*[[1], [2], [1], [2], [1]] //str.impact[0].State*/;

                return ctx.sync().then(function () {
                    //console.log("Success! Insert range in A1:C3.");
                });
            }).catch(function (error) {
                // app.showNotification(error);
            });
        };

        function isActivityType(type) {
            if (type == "Problem") return "0";
            else if (type == "Action") return "1";
            else if (type == "Event") return "2";
            else if (type == "Comment") return "3";
            else if (type == "Decision") return "4";
            else if (type == "Reference") return "5";
            else return null
        }

        function isEnergy(type) {
            if (type == "Mild") return "0";
            else if (type == "Reasonable") return "1";
            else if (type == "Demanding") return "2";
            else if (type == "Very Demanding") return "3";
            else if (type == "Extreme") return "4";
            else return null;
        };

        function isTime(type) {
            if (type == "5 min") return "0";
            else if (type == "15 min") return "1";
            else if (type == "30 min") return "2";
            else if (type == "1 hr") return "3";
            else if (type == "2 hr") return "4";
            else if (type == "4 hr") return "5";
            else if (type == "8 hr") return "6";
            else return null;
        };

        function isResponseStatus(type) {
            if (type == "Inbox") return "0";
            else if (type == "Next") return "1";
            else if (type == "Waiting") return "2";
            else if (type == "Schedule") return "3";
            else if (type == "Someday") return "4";
            else if (type == "Done") return "5";
            else return null;
        };
    </script>
</head>
<body>
    Function file body is never displayed.
</body>
</html>